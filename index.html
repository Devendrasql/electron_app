<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Full Alarm</title>
    <style>
        /* Custom CSS for Inter font and general styling */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #E0F2F7; /* Sky blue background */
            color: #333;
            padding: 16px;
            box-sizing: border-box;
            margin: 0;
        }
        .container {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 32px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        h1 {
            font-size: 30px;
            font-weight: bold;
            color: #333;
        }
        .battery-icon {
            font-size: 80px;
            color: #1A237E; /* Dark blue for battery icon */
            margin-bottom: 16px;
        }
        .battery-level-display {
            font-size: 20px;
            font-weight: 600;
        }
        .battery-level-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 8px;
            height: 20px;
            overflow: hidden;
            margin-top: 8px;
        }
        .battery-fill {
            height: 100%;
            background-color: #1A237E; /* Dark blue for high battery fill */
            border-radius: 8px;
            transition: width 0.5s ease-in-out;
        }
        .charging-indicator {
            font-size: 24px;
            margin-top: 10px;
            color: #3f51b5;
        }
        .section-title {
            font-size: 22px;
            font-weight: bold;
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: none;
        }
        .btn-primary {
            background-color: #1A237E; /* Dark blue for primary buttons */
            color: white;
        }
        .btn-primary:hover {
            background-color: #0D47A1; /* Darker blue on hover */
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #f44336;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #da190b;
            transform: translateY(-2px);
        }
        .btn-info {
            background-color: #2196F3; /* Blue for info/Bluetooth */
            color: white;
        }
        .btn-info:hover {
            background-color: #1976D2;
            transform: translateY(-2px);
        }
        .btn-settings {
            background-color: #607D8B; /* Grey for settings */
            color: white;
        }
        .btn-settings:hover {
            background-color: #455A64;
            transform: translateY(-2px);
        }
        .message-box {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-size: 14px;
            text-align: left;
        }
        .message-box.show {
            display: block;
        }
        .settings-section {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .current-sound-display {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Battery Alarm</h1>

        <!-- Battery Status Section -->
        <div class="section-title">Battery Status</div>
        <div class="battery-icon" id="batteryIcon">ðŸ”‹</div>
        <div class="battery-level-display">
            Battery Level: <span id="batteryLevel">--%</span>
        </div>
        <div class="battery-level-bar">
            <div class="battery-fill" id="batteryFill" style="width: 0%;"></div>
        </div>
        <div class="charging-indicator" id="chargingStatus">
            Status: Not monitoring
        </div>
        <div class="button-group">
            <button id="startButton" class="btn btn-primary">Start Battery Monitoring</button>
            <button id="stopButton" class="btn btn-secondary" disabled>Stop Battery Monitoring</button>
        </div>

        <!-- Bluetooth Control Section -->
        <div class="section-title">Bluetooth Control</div>
        <div class="bluetooth-status-display">
            Bluetooth Status: <span id="bluetoothStatus">Disconnected</span>
        </div>
        <div class="button-group">
            <button id="connectBluetoothButton" class="btn btn-info">Connect Bluetooth Device</button>
            <button id="disconnectBluetoothButton" class="btn btn-secondary" disabled>Disconnect Bluetooth Device</button>
        </div>

        <!-- Settings Section -->
        <div class="section-title">Settings</div>
        <div class="button-group">
            <button id="changeSoundButton" class="btn btn-settings">Change Alarm Sound</button>
            <div class="current-sound-display">
                Current Sound: <span id="currentSoundFileName">Default (your_alarm_sound.mp3)</span>
            </div>
        </div>

        <!-- Custom Message Box for alerts -->
        <div id="messageBox" class="message-box"></div>

        <!-- Audio element for the alarm sound -->
        <audio id="alarmSound" src="" preload="auto"></audio>
    </div>

    <script>
        // --- DOM Elements ---
        const batteryLevelSpan = document.getElementById('batteryLevel');
        const batteryFill = document.getElementById('batteryFill');
        const chargingStatusDiv = document.getElementById('chargingStatus');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const alarmSound = document.getElementById('alarmSound');
        const messageBox = document.getElementById('messageBox');
        const batteryIcon = document.getElementById('batteryIcon');
        const bluetoothStatusSpan = document.getElementById('bluetoothStatus');
        const connectBluetoothButton = document.getElementById('connectBluetoothButton');
        const disconnectBluetoothButton = document.getElementById('disconnectBluetoothButton');
        const changeSoundButton = document.getElementById('changeSoundButton'); // New button
        const currentSoundFileNameSpan = document.getElementById('currentSoundFileName'); // New display

        // --- Global Variables ---
        let battery = null;
        let monitoringInterval = null;
        let alarmPlaying = false;
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;
        let currentSettings = {};

        // --- Bluetooth Service and Characteristic UUIDs ---
        const BLUETOOTH_SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
        const BLUETOOTH_CHARACTERISTIC_UUID = '0000ffe1-0000-1000-8000-00805f9b34fb';

        // --- Utility Functions ---
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'message-box show';
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
            } else {
                messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 5000);
        }

        // --- Battery Monitoring Functions ---
        function updateBatteryStatus() {
            if (!battery) return;

            const level = Math.round(battery.level * 100);
            batteryLevelSpan.textContent = `${level}%`;
            batteryFill.style.width = `${level}%`;

            if (battery.charging) {
                chargingStatusDiv.textContent = 'Status: Charging...';
                batteryIcon.textContent = 'âš¡';
                batteryIcon.style.color = '#3f51b5';
            } else {
                chargingStatusDiv.textContent = 'Status: Discharging';
                batteryIcon.textContent = 'ðŸ”‹';
                batteryIcon.style.color = '#1A237E'; /* Dark blue for battery icon when not charging */
            }

            // Change color of battery fill based on level
            if (level < 20) {
                batteryFill.style.backgroundColor = '#f44336'; /* Red for low battery */
            } else if (level < 50) {
                batteryFill.style.backgroundColor = '#ff9800'; /* Orange for medium battery */
            } else {
                batteryFill.style.backgroundColor = '#1A237E'; /* Dark blue for high battery */
            }

            if (level === 100 && battery.charging) {
                if (!alarmPlaying) {
                    playAlarm();
                    alarmPlaying = true;
                    showMessage('Battery fully charged! Please unplug your device.', 'info');
                }
                sendBluetoothSignal('blink');
            } else if (level < 100 || !battery.charging) {
                alarmPlaying = false;
                sendBluetoothSignal('off');
            }
        }

        function playAlarm() {
            alarmSound.currentTime = 0;
            alarmSound.play().catch(error => {
                console.error("Error playing alarm sound:", error);
                showMessage('Could not play alarm sound. Please interact with the page first (e.g., tap the screen).', 'error');
            });
        }

        function startMonitoring() {
            if (!battery) {
                showMessage('Battery API not available or not initialized.', 'error');
                return;
            }

            if (monitoringInterval) {
                showMessage('Battery monitoring is already active.', 'info');
                return;
            }

            alarmSound.load();
            alarmSound.currentTime = 0;
            alarmSound.volume = 0;
            alarmSound.play().then(() => {
                alarmSound.volume = 1;
                console.log("Dummy audio play successful, audio context likely unlocked.");
                showMessage('Battery monitoring started. The alarm will sound and Bluetooth signal will be sent when 100% charged.', 'info');
            }).catch(error => {
                console.warn("Dummy audio play failed (audio context might still be locked):", error);
                showMessage('Warning: Audio playback might be blocked by your browser. Please ensure you have interacted with the page (e.g., tapped a button) to allow sound. The alarm may not play.', 'error');
            });

            updateBatteryStatus();
            monitoringInterval = setInterval(updateBatteryStatus, 5000);
            startButton.disabled = true;
            stopButton.disabled = true; // Keep stop button disabled until monitoring actually starts
            chargingStatusDiv.textContent = 'Status: Monitoring active...';
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                startButton.disabled = false;
                stopButton.disabled = true;
                chargingStatusDiv.textContent = 'Status: Monitoring stopped.';
                showMessage('Battery monitoring stopped.', 'info');
                sendBluetoothSignal('off');
            } else {
                showMessage('Battery monitoring is not active.', 'info');
            }
        }

        function initBattery() {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(function(b) {
                    battery = b;
                    updateBatteryStatus();

                    battery.addEventListener('chargingchange', updateBatteryStatus);
                    battery.addEventListener('levelchange', updateBatteryStatus);

                    startButton.disabled = false;
                    showMessage('Battery API is ready. Tap "Start Battery Monitoring" to begin.', 'info');
                }).catch(function(error) {
                    console.error("Failed to get battery information:", error);
                    showMessage('Could not access battery information. Please ensure your browser supports the Battery Status API and permissions are granted.', 'error');
                    startButton.disabled = true;
                });
            } else {
                showMessage('Battery Status API is not supported in this browser.', 'error');
                startButton.disabled = true;
            }
        }

        // --- Bluetooth Functions ---
        async function connectBluetoothDevice() {
            if (!navigator.bluetooth) {
                showMessage('Web Bluetooth API is not supported in this browser.', 'error');
                return;
            }

            bluetoothStatusSpan.textContent = 'Connecting...';
            showMessage('Searching for Bluetooth device...', 'info');

            try {
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [BLUETOOTH_SERVICE_UUID] }],
                    optionalServices: [BLUETOOTH_SERVICE_UUID]
                });

                bluetoothDevice.addEventListener('gattserverdisconnected', onBluetoothDisconnected);

                const server = await bluetoothDevice.gatt.connect();
                showMessage(`Connected to ${bluetoothDevice.name || 'Unknown Device'}!`, 'success');
                bluetoothStatusSpan.textContent = `Connected to ${bluetoothDevice.name || 'Unknown Device'}`;
                connectBluetoothButton.disabled = true;
                disconnectBluetoothButton.disabled = false;

                const service = await server.getPrimaryService(BLUETOOTH_SERVICE_UUID);
                bluetoothCharacteristic = await service.getCharacteristic(BLUETOOTH_CHARACTERISTIC_UUID);
                showMessage('Bluetooth characteristic found. Ready to send commands.', 'success');

            } catch (error) {
                console.error('Bluetooth connection error:', error);
                showMessage(`Bluetooth connection failed: ${error.message}`, 'error');
                bluetoothStatusSpan.textContent = 'Disconnected';
                connectBluetoothButton.disabled = false;
                disconnectBluetoothButton.disabled = true;
                bluetoothDevice = null;
                bluetoothCharacteristic = null;
            }
        }

        function onBluetoothDisconnected(event) {
            const device = event.target;
            console.log(`Device ${device.name || 'Unknown Device'} disconnected.`);
            showMessage(`Bluetooth device ${device.name || 'Unknown Device'} disconnected.`, 'info');
            bluetoothStatusSpan.textContent = 'Disconnected';
            connectBluetoothButton.disabled = false;
            disconnectBluetoothButton.disabled = true;
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
        }

        function disconnectBluetoothDevice() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
                showMessage('Bluetooth device disconnected.', 'info');
            } else {
                showMessage('No Bluetooth device is currently connected.', 'info');
            }
            bluetoothStatusSpan.textContent = 'Disconnected';
            connectBluetoothButton.disabled = false;
            disconnectBluetoothButton.disabled = true;
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
        }

        async function sendBluetoothSignal(command) {
            if (!bluetoothCharacteristic) {
                return;
            }

            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(command);
                await bluetoothCharacteristic.writeValue(data);
                console.log(`Command "${command}" sent to Bluetooth device.`);
            } catch (error) {
                console.error('Error sending Bluetooth command:', error);
                showMessage(`Failed to send Bluetooth command "${command}": ${error.message}`, 'error');
                if (error.message.includes("disconnected")) {
                    onBluetoothDisconnected({ target: bluetoothDevice });
                }
            }
        }

        // --- Settings Functions ---
        async function loadAndApplySettings() {
            if (window.electronAPI) {
                currentSettings = await window.electronAPI.loadSettings();
                let alarmSoundPath = currentSettings.alarmSoundPath;

                if (!alarmSoundPath) {
                    alarmSoundPath = await window.electronAPI.getDefaultAlarmSoundPath();
                    currentSoundFileNameSpan.textContent = 'Default (your_alarm_sound.mp3)';
                } else {
                    const fileName = alarmSoundPath.split(/[\\/]/).pop();
                    currentSoundFileNameSpan.textContent = fileName;
                }
                alarmSound.src = alarmSoundPath;
                console.log("Alarm sound path loaded and set to:", alarmSoundPath);
            } else {
                alarmSound.src = "your_alarm_sound.mp3";
                currentSoundFileNameSpan.textContent = 'Default (your_alarm_sound.mp3)';
                console.warn("Running outside Electron or preload.js not working. Using relative path for audio.");
            }
        }

        async function handleChangeSound() {
            // This is the key check. If window.electronAPI is undefined, it means
            // the preload script hasn't successfully injected it.
            if (window.electronAPI && typeof window.electronAPI.openAudioFile === 'function') {
                const filePath = await window.electronAPI.openAudioFile();
                if (filePath) {
                    currentSettings.alarmSoundPath = filePath;
                    await window.electronAPI.saveSettings(currentSettings);
                    alarmSound.src = filePath;
                    const fileName = filePath.split(/[\\/]/).pop();
                    currentSoundFileNameSpan.textContent = fileName;
                    showMessage(`Alarm sound changed to: ${fileName}`, 'success');
                } else {
                    showMessage('No audio file selected.', 'info');
                }
            } else {
                // This is the error message the user is seeing.
                console.error("window.electronAPI or openAudioFile function is not available.");
                showMessage('File selection is only available in the desktop application.', 'error');
            }
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startMonitoring);
        stopButton.addEventListener('click', stopMonitoring);
        connectBluetoothButton.addEventListener('click', connectBluetoothDevice);
        disconnectBluetoothButton.addEventListener('click', disconnectBluetoothDevice);
        changeSoundButton.addEventListener('click', handleChangeSound);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Diagnostic log: Check if Electron's API is available on DOMContentLoaded
            console.log("DOMContentLoaded fired. window.electronAPI:", !!window.electronAPI);

            await loadAndApplySettings();
            initBattery();
        });
    </script>
</body>
</html>
